<dom-module id='nuxeo-star-rating-viz'>
  <template>
    <style></style>
    <nuxeo-es-search id='ratingProvider' query=[[query]] aggregates=[[aggregates]] aggregations={{aggregations}}></nuxeo-es-search>
    <template is="dom-if" if="{{buckets}}">
      <table>
        <template is="dom-repeat" items="{{buckets}}">
          <tr>
            <td>
              <nuxeo-star-rating vote="[[item.from]]"></nuxeo-star-rating>
            </td>
            <td>
              <span>([[item.doc_count]])</span>
            </td>
          </tr>
        </template>
      </table>
    </template>
  </template>
  <script>
    Polymer({
      is: 'nuxeo-star-rating-viz',
      // Expose properties
      properties: {
        docId: {
          type: String,
          notify: true
        },
        query: {
          type: Object,
          notify: true
        },
        aggregates: {
          type: Object,
          notify: true
        },
        aggregations: {
          type: Object,
          notify: true
        },
        buckets: {
          type: Object,
          notify: true,
          value: function() {
            return [];
          }
        }
      },

      observers: [
        // update the suggestion
        'updateDocId(docId)',
        'updateBucket(aggregations)'
      ],
      /* ignoring jshint because "" and naming is depending on ES and Nuxeo here*/
      /* jshint ignore:start */
      updateDocId: function() {
        if (this.docId === undefined) {
          return;
        }
        this.docId = this.docId.replace('/', '');
        this.query = {
          bool: {
            must: [
              {
                constant_score: {
                  filter: {
                    term: {
                      "vote:docId": this.docId
                    }
                  }
                }
              }
            ]
          }
        },
        this.aggregates = {
          article_vote_agg_filter: {
            filter: {
              match_all: {}
            },
            aggregations: {
              article_vote_agg: {
                range: {
                  field: "vote:vote",
                  ranges: [
                    {
                      "key": 5,
                      "from": 5
                    }, {
                      "key": 4,
                      "from": 4,
                      "to": 5
                    }, {
                      "key": 3,
                      "from": 3,
                      "to": 4
                    }, {
                      "key": 2,
                      "from": 2,
                      "to": 3
                    }, {
                      "key": 1,
                      "from": 1,
                      "to": 2
                    }
                  ]
                }
              }
            }
          }
        };
        this.$.ratingProvider.execute();
      },
      updateBucket: function() {
        var tmpbuckets = this.aggregations.article_vote_agg_filter.article_vote_agg.buckets;
        tmpbuckets.reverse();
        if (this.buckets.length === 5) {
          this.splice('buckets', 0, 5);
        }
        for (var i = 0; i < tmpbuckets.length; i++) {
          this.push('buckets', tmpbuckets[i]);
        }
        this.set('buckets', this.buckets);
      }
      /* jshint ignore:end */
    });
  </script>

</dom-module>
